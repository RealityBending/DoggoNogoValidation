<!DOCTYPE html>
<html>
    <head>
        <title>Simple RT task</title>
        <script src="https://unpkg.com/jspsych@7.3.4"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3">
            // html-keyboard-response plugin for allowing keyboard responses to html text stimuli
        </script>
        <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3">
            // image-keyboard-response plugin for allowing keyboard responses to visual stimuli
        </script>
        <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3">
            // Use preload plugin to preload the media elements to prevent lag
        </script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3">
            // Likert scale for survey questions
        </script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3">
            // Text response for survey questions
        </script>
        <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.2.0">
            // Button response for consent
        </script>
        <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    </head>
    <body></body>
    <script>

        var participant_id = "participant_id" // for file naming
        var upper_isi = 6000
        var lower_isi = 500
        var isi_steps = 250 // increment increase between lower and upper ISIs
        var n_trials = 5 // number of trials (per stimulus)
        var max_rt = 600 // maximum reaction time allowed
        var response_choices = [' ']
        var test_stimuli = [
            {stimulus: "stimuli/red_square.png", correct_response: ' '}
        ];
        
        var jsPsych = initJsPsych({
            on_finish: function(){
                jsPsych.data.displayData(); //,
                // jsPsych.data.get().localSave('csv', `${participant_id}.csv`); // save data locally
            }
        }); 

        var timeline = [];

        var preload = {
            type: jsPsychPreload,
            images: ['stimuli/red_square.png']
        };

        timeline.push(preload)


        // Welcome
        var welcome = {
            type: jsPsychHtmlKeyboardResponse, 
            stimulus: "Welcome to the experiment. Press any key to begin."
        };

        timeline.push(welcome);


        // Consent
        var consent = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<div>
                <p>INSERT CONSENT DETAILS HERE</p>
                <p>If you have read and <strong>agree</strong> to the above terms, please press the '<strong>I consent</strong>' button below to continue.</p>
                </div>
                `,
            choices: ['I consent', 'I <strong>do not</strong> consent'],
            on_finish: function(data) {
                if (data.response == 1){
                    jsPsych.endExperiment('You have cancelled the experiment. You may now close this window.')
                }
            }
        };

        timeline.push(consent);


        // Instructions
        var instructions = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
            <p>In this experiment, a fixation cross (+) will appear in the center 
            of the screen, followed by a red square.</p>
            <p>Whenever the red square appears, 
            press the <strong>space bar</strong> as fast as you can.</p>
            <div style='width: 700px;'>
            <div style='float: center;'><img src='stimuli/red_square.png'></img>
            </div>
            <p>Press any key to begin.</p>
            `,
            post_trial_gap: 2000
        };

        timeline.push(instructions);


        // Fixation trials
        // ?? MAKE DYNAMIC ISI ??

        var fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="font-size:60px;">+</div>',
            choices: response_choices,
            trial_duration: function(){
                var prev_trial_data = jsPsych.data.get().last(1).values()[0]
                if (prev_trial_data.premature_response == true){
                    return prev_trial_data.fixation_duration
                } else {
                var fx_vals = [];
                var n = 0;
                while (lower_isi+n*isi_steps <= upper_isi){
                    fx_vals.push(lower_isi+n*isi_steps)
                    var n = n + 1
                }
                var trial_isi = jsPsych.randomization.sampleWithoutReplacement(fx_vals, 1)[0];
                return trial_isi
            }
            },
            data: {
                task: 'fixation',
            },
            on_start: function(trial) {
                trial.data.fixation_duration = trial.trial_duration
            },
            on_finish: function(data){
                data.premature_response = data.response !== null;
            }
        };

        
        var fixation_procedure = {
            timeline: [fixation],
            loop_function: function(data) {
                var last_fx_trial = jsPsych.data.get().last(1).values()[0];
                return last_fx_trial.premature_response
            }
        };


        // RT trials
        var test = {
            type: jsPsychImageKeyboardResponse,
            stimulus: jsPsych.timelineVariable('stimulus'),
            choices: response_choices,
            trial_duration: max_rt,
            data: {
                task: 'response',
                correct_response: jsPsych.timelineVariable('correct_response')
            },
            on_finish: function(data){
                data.correct = jsPsych.pluginAPI.compareKeys(data.response, data.correct_response);
            } // too slow -> correct = false
        };


        // Linking fixation and RT trials
        var test_procedure = {
            timeline: [fixation_procedure, test],
            timeline_variables: test_stimuli,
            randomize_order: true, // relevant when > 1 stimulus. When true and reps > 1, order will be re-randomised on each repetition (same stim could appear no more than twice in a row: at end of one rep and start of another)
            // to randomise across all trials, use `fixed-repetitions` - this combines all repetitions and randomizes whole thing, so the same stimulus could appear multiple times in a row.
            repetitions: n_trials // test stimuli will be shown N times (i.e., total trials = N*N_stims)
        };

        timeline.push(test_procedure);


        // Questions

        // Duration
        // Adapted from https://stackoverflow.com/a/51505143/13343754
        var duration_q = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div>
                <p>Without checking, how long do you feel you spent on this task? Please answer in minutes.</p>
                <input type="text" id="numericInput" placeholder="Time in minutes">
                <p><button id="submitButton">Continue</button></p>
            </div>
        `,
        choices: [],
        on_load: function() {
            document.getElementById("numericInput").addEventListener('input', function (event) {
                var input = event.target;
                if (!validateInput(input.value)) {
                    input.value = oldValue;
                } else {
                    oldValue = input.value;
                }
            });

            document.getElementById("submitButton").addEventListener('click', function () {
                jsPsych.data.write({ duration_estimate: document.getElementById("numericInput").value });
                jsPsych.finishTrial();
            });

            function validateInput(str) {
                return /^[0-9]*$/.test(str);
            }

            var oldValue = "";
        }
    };

        timeline.push(duration_q)


        // Enjoyment
        var repeat_desirability_labels = ["Very annoyed", "Slightly annoyed", "Indifferent", "Slightly happy", "Very happy"]
        var repeat_q = {
            type: jsPsychSurveyLikert,
            questions: [
                {
                    prompt: "How would you feel if you had to do the task again?",
                    labels: repeat_desirability_labels, 
                    name: "repeat_desirability", 
                    required: true
                }
            ],
            on_finish: function(data) {
                var responseIndex = data.response['repeat_desirability'];
                var labels = repeat_desirability_labels;
                data.response_text = labels[responseIndex]
            }
        }

        timeline.push(repeat_q)


        // Debrief
        // TO DO : ADD ANY FURTHER DETAILS, E.G., LINK??
        var debrief_block = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function(){
                var trials = jsPsych.data.get().filter({task:'response'});
                var correct_trials = trials.filter({correct: true});
                // var accuracy = Math.round(correct_trials.count()/trials.count()*100);
                var rt = Math.round(correct_trials.select('rt').mean());

                return `
                <p>Your average response time was ${rt}ms.</p>
                <p>Press any key to complete the experiment. Thank you!</p>`
            }
        };

        timeline.push(debrief_block)

        jsPsych.run(timeline)

    </script>
</html>
